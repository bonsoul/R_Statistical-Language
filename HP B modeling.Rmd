---
title: "Marakwet"
author: "Bonsoul"
date: "2025-10-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(pacman)
```

```{r, libraries, include=FALSE}
pacman::p_load(dplyr, readr, tidyr, ggplot2, stringr, janitor,knitr,logistf, kableExtra, tibble,broom)
```


```{r,dataset, include=FALSE}
df1 <- read_csv("D:/Downloads/Final Household data Edit.csv")
df2 <- read_csv("D:/Downloads/HCW Excel Final Edit.csv")
df3 <- read_csv("D:/Downloads/Prison Excel Final Edit.csv")

```




```{r, include=FALSE}
library(dplyr)

summary_table <- df1 %>%
  group_by(N6SubCounty) %>%
  summarise(
    No_tested = n(),
    No_positive = sum(PositiveforHepatitisB == 1, na.rm = TRUE),
    No_negative = sum(NegativeforHepatitisB == 1, na.rm = TRUE),
    Positivity_rate = round(100 * No_positive / No_tested, 1),
    HCW_Vaccinated = sum(Vaccination == 1 & EmployedintheHealthSector == 1, na.rm = TRUE),
    Total_vaccinated = sum(Vaccination == 1, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  bind_rows(
    summarise(., across(where(is.numeric), \(x) sum(x, na.rm = TRUE)),
              N6SubCounty = "Total")
  )

```



```{r, include=TRUE}

# Print summary table in kable
kable(summary_table,
      caption = "Hepatitis B Screening and Vaccination Summary by Sub-County",
      align = "c",
      col.names = c("Sub-County", "No. Tested", "No. Positive", 
                    "No. Negative", "Positivity Rate (%)", 
                    "HCW Vaccinated", "Total Vaccinated"))

```





```{r, include=FALSE}
df10 <- df1 %>%
  mutate(N7Ward_clean = case_when(
    str_detect(N7Ward, regex("kabartonjo|kabaritonjo|karbatonjo", ignore_case = TRUE)) ~ "Kabartonjo",
    str_detect(N7Ward, regex("saimo\\s*kipsaraman", ignore_case = TRUE)) ~ "Saimo Kipsaraman",
    str_detect(N7Ward, regex("saimosoi", ignore_case = TRUE)) ~ "Saimosoi",
    str_detect(N7Ward, regex("barwesa|barwessa|barwessaa", ignore_case = TRUE)) ~ "Barwessa",
    str_detect(N7Ward, regex("bartabwa", ignore_case = TRUE)) ~ "Bartabwa",
    str_detect(N7Ward, regex("mukutani|mukutan[iy]|makutanii|Mukatanii", ignore_case = TRUE)) ~ "Mukutani",
    str_detect(N7Ward, regex("ilichamus|ilchamus", ignore_case = TRUE)) ~ "Ilchamus",
    str_detect(N7Ward, regex("muchongoi|mochongoi|mchongoi", ignore_case = TRUE)) ~ "Muchongoi",
    str_detect(N7Ward, regex("kisanana", ignore_case = TRUE)) ~ "Kisanana",
    str_detect(N7Ward, regex("mogotio|mogoti", ignore_case = TRUE)) ~ "Mogotio",
    str_detect(N7Ward, regex("emining", ignore_case = TRUE)) ~ "Emining",
    str_detect(N7Ward, regex("marigat|margat", ignore_case = TRUE)) ~ "Marigat",
    TRUE ~ N7Ward
  ))


```




```{r,Age and Sex, include=TRUE}

df10 %>%
  # remove missing/nulls in Age and Sex
  filter(!is.na(N1Ageinyears1), !is.na(N2Sex1), N2Sex1 != "") %>%
  
  # create age groups
  mutate(AgeGroup = cut(N1Ageinyears1,
                        breaks = c(0, 14, 24, 34, 44, 100),
                        labels = c("0-14", "15-24", "25-34", "35-44", "45+"),
                        right = TRUE)) %>%
  
  # group and summarise
  group_by(AgeGroup, N2Sex1) %>%
  summarise(n = n(), .groups = "drop") %>%
  
  # add percentage
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  
  # pretty table
  kable(caption = "Table 1: Age and Sex Distribution") %>%
  kable_styling(full_width = FALSE, position = "center")

```


```{r, Education Status, include=TRUE}

# 2a. Education Status
df1 %>%
  filter(!is.na(N7Haveyouhadformaleducation1), N7Haveyouhadformaleducation1 != "") %>% 
  group_by(N7Haveyouhadformaleducation1) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 2: Education Status of Respondents") %>%
  kable_styling(full_width = FALSE, position = "center")


```



```{r, status, include=TRUE}


df10 %>%
  filter(!is.na(N10Whatisyourmaritalstatus), N10Whatisyourmaritalstatus != "") %>%
  group_by(N10Whatisyourmaritalstatus) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 4: Marital Status of Respondents") %>%
  kable_styling(full_width = FALSE, position = "center")

```

```{r,Religion, include=TRUE}
df10 %>%
  filter(!is.na(N9Whatisyourreligion)) %>%   # <- added %>%
  group_by(N9Whatisyourreligion) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 5: Religion of Respondents") %>%
  kable_styling(full_width = FALSE, position = "center")

```

```{r, Reproductive Health, include=TRUE}
df10 %>%
  filter(N2Sex1 == "Female" & !is.na(N3Areyoucurrentlypregnant1)) %>%
  group_by(N3Areyoucurrentlypregnant1) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 6: Pregnancy Status (Females only)") %>%
  kable_styling(full_width = FALSE, position = "center")
```



```{r, Alcohol Consumption, include=TRUE}

df10 %>%
  filter(!is.na(N15Doyouconsumealcohol)) %>%
  group_by(N15Doyouconsumealcohol) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 7: Alcohol Consumption among Respondents") %>%
  kable_styling(full_width = FALSE, position = "center")

```

```{r, include=TRUE}
df10 %>%
  filter(!is.na(N20Howmanysexualpartnershaveyouhadinthelast12months)) %>%
  group_by(N20Howmanysexualpartnershaveyouhadinthelast12months) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 8: Number of Sexual Partners in Last 12 Months") %>%
  kable_styling(full_width = FALSE, position = "center")
```


```{r,Cultural / Risk Practices, include=TRUE}
df10 %>%
  filter(!is.na(N49Haveyoubeencircumcised)) %>%
  group_by(N49Haveyoubeencircumcised) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 9: Circumcision Status") %>%
  kable_styling(full_width = FALSE, position = "center")

df10 %>%
  filter(!is.na(N54Haveyouhadanytraditionalmarkstattoosbodyincisionsorpiercingsd)) %>%
  group_by(N54Haveyouhadanytraditionalmarkstattoosbodyincisionsorpiercingsd) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(caption = "Table 10: Traditional Marks / Tattoos / Piercings") %>%
  kable_styling(full_width = FALSE, position = "center")
```



```{r, include=FALSE}
df10 <- df10 %>%
  mutate(AgeGroup = cut(N1Ageinyears1,
                        breaks = c(0, 24, 34, 44, 54, Inf),
                        labels = c("<25", "25-34", "35-44", "45-54", "â‰¥55"),
                        right = TRUE))

```




```{r, include=FALSE}
df10 <- df10 %>%
  mutate(
    HBV_Status = case_when(
      PositiveforHepatitisB == "Yes" ~ "Positive",
      NegativeforHepatitisB == "Yes" ~ "Negative",
      Dontknow == "Yes" ~ "Dontknow",
      TRUE ~ NA_character_
    )
  )

```

```{r, include=FALSE}
df10_clean <- df10 %>%
  filter(!is.na(HBV_Status))

```


```{r, include=FALSE}

sex_tab <- df10_clean %>%
  filter(!is.na(HBV_Status), !is.na(N2Sex1)) %>%   # filter nulls in both variables
  group_by(N2Sex1, HBV_Status) %>%
  summarise(n = n(), .groups = "drop") %>%
  pivot_wider(
    id_cols = N2Sex1,
    names_from = HBV_Status,
    values_from = n,
    values_fill = list(n = 0)
  ) %>%
  mutate(
    Pos_pct = round(100 * Positive / sum(Positive), 1),
    Neg_pct = round(100 * Negative / sum(Negative), 1),
    Positive = paste0(Positive, " (", Pos_pct, "%)"),
    Negative = paste0(Negative, " (", Neg_pct, "%)")
  ) %>%
  select(Sex = N2Sex1, Positive, Negative)

```

```{r, include=TRUE}
# Print in kable format
sex_tab %>%
  kable(caption = "Table: HBV Status by Sex") %>%
  kable_styling(full_width = FALSE, position = "center")
```


```{r, include=FALSE}
# Keep only Positive and Negative, drop Dontknow & NAs
df10_clean <- df10_clean %>%
  filter(HBV_Status %in% c("Positive", "Negative")) %>%
  mutate(HBV_binary = ifelse(HBV_Status == "Positive", 1, 0))

# Double check
table(df10_clean$HBV_binary, df10_clean$HBV_Status)



```



```{r, include=FALSE}
library(dplyr)
library(broom)
library(knitr)
library(kableExtra)

# Recode outcome
df10_clean <- df10_clean %>%
  mutate(HBV_binary = ifelse(HBV_Status == "Positive", 1, 0))

# Logistic regression
model_sex <- glm(HBV_binary ~ N2Sex1, data = df10_clean, family = binomial)

# Get tidy output with ORs and CIs
model_results <- tidy(model_sex, conf.int = TRUE, exp = TRUE) %>%
  mutate(across(estimate:conf.high, round, 2)) %>%
  rename(
    Term = term,
    OR = estimate,
    CI_low = conf.low,
    CI_high = conf.high,
    p_value = p.value
  )

```


```{r, include=TRUE}
# Print in kable format
kable(model_results, format = "markdown", caption = "Logistic Regression: HBV Positive vs Not Positive") %>%
  kable_styling(full_width = FALSE, position = "left")
```



```{r, include=TRUE}
# Keep only Positive and Negative, drop Dontknow & NAs
df101 <- df10 %>%
  filter(HBV_Status %in% c("Positive", "Negative")) %>%
  mutate(HBV_binary = ifelse(HBV_Status == "Positive", 1, 0))

# Double check
table(df101$HBV_binary, df101$HBV_Status)
```


```{r, include=FALSE}
alias(lm(HBV_binary ~ N2Sex1 + AgeGroup + N10Whatisyourmaritalstatus +
           N7Haveyouhadformaleducation1 + N49Haveyoubeencircumcised +
           N20Howmanysexualpartnershaveyouhadinthelast12months +
           N44Doyoushave + N15Doyouconsumealcohol,
         data = df101))

```


```{r, include=FALSE}
model_adj_firth <- logistf(
  HBV_binary ~ N2Sex1 + AgeGroup + N10Whatisyourmaritalstatus + N44Doyoushave,
  data = df101
)
summary(model_adj_firth)

```

```{r, include=TRUE}

# Extract OR and CI
results_firth <- exp(cbind(OR = coef(model_adj_firth),
                           confint(model_adj_firth))) %>%
  as.data.frame() %>%
  rownames_to_column("Variable")

# Print to check names
print(colnames(results_firth))

# Force rename to consistent names
colnames(results_firth) <- c("Variable", "OR", "CI_lower", "CI_upper")

# Create clean table
results_firth <- results_firth %>%
  mutate(`aOR (95% CI)` = sprintf("%.2f (%.2fâ€“%.2f)", OR, CI_lower, CI_upper)) %>%
  select(Variable, `aOR (95% CI)`)


results_firth
```



###data2




```{r, include=FALSE}

# ---- Step 1: Clean and categorize Department ----
df2_cat <- df2 %>%
  mutate(DepartmentClean = case_when(
    str_detect(str_to_upper(Q11departmentstationed), "WARD|WARDS") ~ "Ward",
    str_detect(str_to_upper(Q11departmentstationed), "NURSE") ~ "Nursing",
    str_detect(str_to_upper(Q11departmentstationed), "PHARM|PHARMACY|pHARM") ~ "Pharmacy",
    str_detect(str_to_upper(Q11departmentstationed), "LAB|LABORATORY") ~ "Laboratory",
    str_detect(str_to_upper(Q11departmentstationed), "PUBLIC HEALTH|HTS|VCT|CCC|MCH/MATERNITY|MCH") ~ "Public Health/MCH",
    str_detect(str_to_upper(Q11departmentstationed), "PROCUREMENT|ACCOUNTS|RECORD|RECORDS|ReCORDS") ~ "Administration/Records",
    str_detect(str_to_upper(Q11departmentstationed), "SECURITY") ~ "Security",
    str_detect(str_to_upper(Q11departmentstationed), "CLEAN|LAUNDRY") ~ "Cleaning/Maintenance",
    str_detect(str_to_upper(Q11departmentstationed), "KITCHEN") ~ "Kitchen",
    str_detect(str_to_upper(Q11departmentstationed), "SURGERY|SURGICAL|OBSTETRICS/GYNAECOLOGY") ~ "Surgery/Obstetrics",
    str_detect(str_to_upper(Q11departmentstationed), "NUTRITION|MSW|WATVHMAN") ~ "Other",
    TRUE ~ "Other"
  ))

# ---- Step 2: Categorize age, years of practice, and select sociodemographics ----
df2_cat <- df2_cat %>%
  mutate(
    AgeGroup = case_when(
      Q08Ageinyears < 25 ~ "<25",
      Q08Ageinyears >= 25 & Q08Ageinyears <= 34 ~ "25-34",
      Q08Ageinyears >= 35 & Q08Ageinyears <= 44 ~ "35-44",
      Q08Ageinyears >= 45 & Q08Ageinyears <= 54 ~ "45-54",
      Q08Ageinyears >= 55 ~ "â‰¥55",
      TRUE ~ NA_character_
    ),
    YearsPracticeGroup = case_when(
      Q10yearsofpractice < 5 ~ "<5",
      Q10yearsofpractice >= 5 & Q10yearsofpractice <= 10 ~ "5-10",
      Q10yearsofpractice > 10 ~ ">10",
      TRUE ~ NA_character_
    ),
    Sex = factor(Q07Sex, levels = c("Female", "Male")),
    Cadre = factor(Q08Cadre),
    Education = factor(Q09levelofeducation),
    Department = factor(DepartmentClean, levels = c(
      "Ward", "Nursing", "Pharmacy", "Laboratory", 
      "Public Health/MCH", "Administration/Records", 
      "Security", "Cleaning/Maintenance", "Kitchen", 
      "Surgery/Obstetrics", "Other"
    )),
    FacilityLevel = factor(Q05Leveloffacility),
    FacilityOwnership = factor(Q06Facilityownership),
    SubCounty = factor(Q01SubCounty)
  )

# ---- Step 3: Function to generate frequency tables (filter out NAs) ----
freq_table <- function(var, varname) {
  df2_cat %>%
    filter(!is.na({{var}})) %>%   # Filter nulls
    count({{var}}, name = "n") %>%
    mutate(percent = round(100 * n / sum(n), 1),
           Variable = varname) %>%
    rename(Value = {{var}})
}

# ---- Step 4: Generate tables for each characteristic ----
tables <- list(
  freq_table(Sex, "Sex"),
  freq_table(AgeGroup, "Age group"),
  freq_table(Education, "Level of education"),
  freq_table(Cadre, "Cadre"),
  freq_table(Department, "Department"),
  freq_table(FacilityLevel, "Facility level"),
  freq_table(FacilityOwnership, "Facility ownership"),
  freq_table(SubCounty, "SubCounty"),
  freq_table(YearsPracticeGroup, "Years of practice")
)

# ---- Step 5: Combine all tables ----
final_table <- bind_rows(tables) %>%
  select(Variable, Value, n, percent)


```


```{r, include=TRUE}
final_table %>%
  kable(
    caption = "Sociodemographic characteristics of participants ",
    col.names = c("Characteristic", "Category", "n", "Percent"),
    align = "lccc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")
```

```{r, include=FALSE}

# ---- Prepare vaccination table ----
vaccine_table <- df2 %>%
  filter(!is.na(Q15Vaccinationstatus)) %>%          # Remove missing values
  count(Q15Vaccinationstatus) %>%                  # Count each category
  mutate(percent = round(100 * n / sum(n), 1)) %>% # Calculate percentage
  rename(Status = Q15Vaccinationstatus)


```

```{r,Vaccination Status, include=TRUE}
vaccine_table %>%
  kable(
    caption = "HBV Vaccination Status of Participants",
    col.names = c("Vaccination status", "n", "Percent"),
    align = "lcc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")
```




##data3


```{r, include=FALSE}

# ---- Categorize variables ----
df3_cat <- df3 %>%
  mutate(
    AgeGroup = case_when(
      Age < 25 ~ "<25",
      Age >= 25 & Age <= 34 ~ "25-34",
      Age >= 35 & Age <= 44 ~ "35-44",
      Age >= 45 & Age <= 54 ~ "45-54",
      Age >= 55 ~ "â‰¥55",
      TRUE ~ NA_character_
    ),
    EducationGroup = case_when(
      str_detect(LevelofEducation, "None|No") ~ "None/No Education",
      str_detect(LevelofEducation, "Primary") ~ "Primary",
      str_detect(LevelofEducation, "Secondary") ~ "Secondary",
      str_detect(LevelofEducation, "Tertiary|College|University") ~ "Tertiary",
      TRUE ~ "Other"
    ),
    MaritalStatus = MaritalStatus,
    PrisonType = PrisonType,
    RespondentCategory = Categoryoftherespondent1,
    ReligionGroup = case_when(
      !is.na(Protestant) & Protestant == "Yes" ~ "Protestant",
      !is.na(Catholic) & Catholic == "Yes" ~ "Catholic",
      !is.na(Muslim) & Muslim == "Yes" ~ "Muslim",
      TRUE ~ "Other"
    )
  ) %>%
  filter(!is.na(AgeGroup), !is.na(EducationGroup), !is.na(MaritalStatus))

# ---- Helper function for frequency table ----
freq_table <- function(var, varname) {
  df3_cat %>%
    count({{var}}) %>%
    mutate(percent = round(100 * n / sum(n), 1),
           Variable = varname) %>%
    rename(Category = {{var}})
}

# ---- Generate tables ----
tables <- list(
  freq_table(AgeGroup, "Age group"),
  freq_table(EducationGroup, "Level of education"),
  freq_table(MaritalStatus, "Marital status"),
  freq_table(PrisonType, "Prison type"),
  freq_table(RespondentCategory, "Respondent category"),
  freq_table(ReligionGroup, "Religion")
)

# ---- Combine all tables ----
final_demo_table <- bind_rows(tables) %>%
  select(Variable, Category, n, percent)


```

```{r, include=TRUE}
final_demo_table %>%
  kable(
    caption = "Sociodemographic characteristics of respondents",
    col.names = c("Characteristic", "Category", "n", "Percent"),
    align = "lccc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")
```



```{r, include=TRUE}

df3 %>%
  count(`Field screening diaspot (HBsAg) RDT`) %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(
    caption = "HBV Positivity (Field Screening Diaspot HBsAg RDT)",
    col.names = c("HBV Status", "n", "Percent"),
    align = "lcc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")


```



```{r, include=TRUE}

df3_cat %>%
  group_by(AgeGroup, N24HaveyoueverbeenvaccinatedagainstHepatitisBbefore) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  arrange(AgeGroup) %>%
  kable(
    caption = "HBV Vaccination Status by Age Group",
    col.names = c("Age Group", "Vaccinated", "n", "Percent"),
    align = "lccc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")


```












