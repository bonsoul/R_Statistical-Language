---
title: "Marakwet"
author: "Bonsoul"
date: "2025-10-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(pacman)
```

```{r, libraries, include=FALSE}
pacman::p_load(dplyr, readr, tidyr, ggplot2, stringr, janitor,knitr,logistf, kableExtra, tibble,broom)
```


```{r,dataset, include=FALSE}
df1 <- read_csv("D:/Downloads/Final Household data Edit.csv")
df2 <- read_csv("D:/Downloads/HCW Excel Final Edit.csv")
df3 <- read_csv("D:/Downloads/Prison Excel Final Edit.csv")

```




```{r, include=FALSE}
# Convert relevant columns from Yes/No to numeric
df1 <- df1 %>%
  mutate(
    PositiveforHepatitisB = ifelse(PositiveforHepatitisB == "Yes", 1, 0),
    NegativeforHepatitisB = ifelse(NegativeforHepatitisB == "Yes", 1, 0),
    Vaccination = ifelse(Vaccination == "Yes", 1, 0),
    EmployedintheHealthSector = ifelse(EmployedintheHealthSector == "Yes", 1, 0)
  )

# Create summary table by SubCounty
summary_table <- df1 %>%
  group_by(N6SubCounty) %>%
  summarise(
    No_tested = n(),
    No_positive = sum(PositiveforHepatitisB, na.rm = TRUE),
    No_negative = sum(NegativeforHepatitisB, na.rm = TRUE),
    Positivity_rate = round(100 * No_positive / No_tested, 1),
    HCW_Vaccinated = sum(Vaccination & EmployedintheHealthSector, na.rm = TRUE),
    Total_vaccinated = sum(Vaccination, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Add a row for totals
  bind_rows(
    summarise(
      ., 
      N6SubCounty = "Total",
      across(where(is.numeric), ~ sum(.x, na.rm = TRUE))
    )
  )

# Print nicely
library(kableExtra)
summary_table %>%
  kable(
    col.names = c("Sub-County", "No. Tested", "No. Positive", "No. Negative",
                  "Positivity Rate (%)", "HCW Vaccinated", "Total Vaccinated"),
    caption = "Table: Hepatitis B Testing and Vaccination Summary by Sub-County"
  ) %>%
  kable_styling(full_width = FALSE, position = "center",
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```



```{r}
df1 <- df1 %>%
  mutate(
    # Create a single HBV_status column first
    HBV_status = case_when(
      PositiveforHepatitisB == "Yes" ~ "Positive",
      NegativeforHepatitisB == "Yes" ~ "Negative",
      Dontknow == "Yes" ~ "Dont know",
      TRUE ~ NA_character_  # for missing/unrecorded
    ),
    
    # Convert to numeric for summaries
    PositiveforHepatitisB = ifelse(HBV_status == "Positive", 1, 0),
    NegativeforHepatitisB = ifelse(HBV_status == "Negative", 1, 0),
    Dontknow_HBV = ifelse(HBV_status == "Dont know", 1, 0),
    
    # Other binary columns
    Vaccination = ifelse(Vaccination == "Yes", 1, 0),
    EmployedintheHealthSector = ifelse(EmployedintheHealthSector == "Yes", 1, 0)
  )

```

```{r}
library(dplyr)

# Step 1: Summarize by sub-county
summary_table <- df1 %>%
  group_by(N6SubCounty) %>%
  summarise(
    No_tested = n(),
    No_positive = sum(PositiveforHepatitisB, na.rm = TRUE),
    No_negative = sum(NegativeforHepatitisB, na.rm = TRUE),
    No_dontknow = sum(Dontknow_HBV, na.rm = TRUE),
    Positivity_rate = round(100 * No_positive / No_tested, 1),
    HCW_Vaccinated = sum(Vaccination & EmployedintheHealthSector, na.rm = TRUE),
    Total_vaccinated = sum(Vaccination, na.rm = TRUE)
  ) %>%
  ungroup()

# Step 2: Add a total row
total_row <- summary_table %>%
  summarise(
    N6SubCounty = "Total",
    No_tested = sum(No_tested, na.rm = TRUE),
    No_positive = sum(No_positive, na.rm = TRUE),
    No_negative = sum(No_negative, na.rm = TRUE),
    No_dontknow = sum(No_dontknow, na.rm = TRUE),
    Positivity_rate = round(100 * sum(No_positive, na.rm = TRUE) / sum(No_tested, na.rm = TRUE), 1),
    HCW_Vaccinated = sum(HCW_Vaccinated, na.rm = TRUE),
    Total_vaccinated = sum(Total_vaccinated, na.rm = TRUE)
  )

# Step 3: Combine
summary_table <- bind_rows(summary_table, total_row)

# Step 4: Print nicely with kableExtra
library(kableExtra)

summary_table %>%
  kable(
    col.names = c("Sub-County", "No. Tested", "No. Positive", "No. Negative", 
                  "No. Don't know", "Positivity Rate (%)", "HCW Vaccinated", "Total Vaccinated"),
    caption = "Summary of Hepatitis B testing and vaccination by Sub-County, Baringo County, Kenya, 2019"
  ) %>%
  kable_styling(full_width = FALSE, position = "center",
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```


```{r}
library(dplyr)
library(knitr)
library(kableExtra)

# Step 0: Convert Yes/No to 1/0
df1 <- df1 %>%
  mutate(
    PositiveforHepatitisB = ifelse(PositiveforHepatitisB == "Yes", 1, 0),
    NegativeforHepatitisB = ifelse(NegativeforHepatitisB == "Yes", 1, 0),
    Dontknow_HBV = ifelse(Dontknow == "Yes", 1, 0),
    Vaccination = ifelse(Vaccination == "Yes", 1, 0),
    EmployedintheHealthSector = ifelse(EmployedintheHealthSector == "Yes", 1, 0)
  )

# Step 1: Summarize by sub-county
summary_table <- df1 %>%
  group_by(N6SubCounty) %>%
  summarise(
    No_tested = n(),
    No_positive = sum(PositiveforHepatitisB, na.rm = TRUE),
    No_negative = sum(NegativeforHepatitisB, na.rm = TRUE),
    No_dontknow = sum(Dontknow_HBV, na.rm = TRUE),
    HCW_Vaccinated = sum(Vaccination == 1 & EmployedintheHealthSector == 1, na.rm = TRUE),
    Total_vaccinated = sum(Vaccination, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Positivity_rate = round(100 * No_positive / No_tested, 1))

# Step 2: Add total row
total_row <- summary_table %>%
  summarise(
    N6SubCounty = "Total",
    No_tested = sum(No_tested),
    No_positive = sum(No_positive),
    No_negative = sum(No_negative),
    No_dontknow = sum(No_dontknow),
    HCW_Vaccinated = sum(HCW_Vaccinated),
    Total_vaccinated = sum(Total_vaccinated),
    Positivity_rate = round(100 * sum(No_positive) / sum(No_tested), 1)
  )

summary_table <- bind_rows(summary_table, total_row)

# Step 3: Pretty print
summary_table %>%
  kable(
    col.names = c("Sub-County", "No. Tested", "No. Positive", "No. Negative",
                  "No. Don't know", "HCW Vaccinated", "Total Vaccinated", "Positivity Rate (%)"),
    caption = "Table: Summary of Hepatitis B Testing and Vaccination by Sub-County"
  ) %>%
  kable_styling(full_width = FALSE, position = "center",
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```



```{r}
summary_table <- df1 %>%
  group_by(N6SubCounty) %>%
  summarise(
    No_tested = n(),
    No_positive = sum(PositiveforHepatitisB, na.rm = TRUE),
    No_negative = sum(NegativeforHepatitisB, na.rm = TRUE),
    No_dontknow = sum(Dontknow_HBV, na.rm = TRUE),
    Positivity_rate = round(100 * No_positive / No_tested, 1),
    HCW_Vaccinated = sum(Vaccination & EmployedintheHealthSector, na.rm = TRUE),
    Total_vaccinated = sum(Vaccination, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  bind_rows(
    summarise(., 
              N6SubCounty = "Total",
              across(where(is.numeric), ~ sum(.x, na.rm = TRUE))
    )
  )

summary_table %>%
  kable(
    col.names = c("Sub-County", "No. Tested", "No. Positive", "No. Negative", "No. Don't know",
                  "Positivity Rate (%)", "HCW Vaccinated", "Total Vaccinated"),
    caption = "Table: Hepatitis B Testing and Vaccination Summary by Sub-County"
  ) %>%
  kable_styling(full_width = FALSE, position = "center",
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```




```{r, include=TRUE}

# Print summary table in kable
kable(summary_table,
      caption = "Hepatitis B Screening and Vaccination Summary by Sub-County",
      align = "c",
      col.names = c("Sub-County", "No. Tested", "No. Positive", 
                    "No. Negative", "Positivity Rate (%)", 
                    "HCW Vaccinated", "Total Vaccinated"))

```





```{r, include=FALSE}
df10 <- df1 %>%
  mutate(N7Ward_clean = case_when(
    str_detect(N7Ward, regex("kabartonjo|kabaritonjo|karbatonjo", ignore_case = TRUE)) ~ "Kabartonjo",
    str_detect(N7Ward, regex("saimo\\s*kipsaraman", ignore_case = TRUE)) ~ "Saimo Kipsaraman",
    str_detect(N7Ward, regex("saimosoi", ignore_case = TRUE)) ~ "Saimosoi",
    str_detect(N7Ward, regex("barwesa|barwessa|barwessaa", ignore_case = TRUE)) ~ "Barwessa",
    str_detect(N7Ward, regex("bartabwa", ignore_case = TRUE)) ~ "Bartabwa",
    str_detect(N7Ward, regex("mukutani|mukutan[iy]|makutanii|Mukatanii", ignore_case = TRUE)) ~ "Mukutani",
    str_detect(N7Ward, regex("ilichamus|ilchamus", ignore_case = TRUE)) ~ "Ilchamus",
    str_detect(N7Ward, regex("muchongoi|mochongoi|mchongoi", ignore_case = TRUE)) ~ "Muchongoi",
    str_detect(N7Ward, regex("kisanana", ignore_case = TRUE)) ~ "Kisanana",
    str_detect(N7Ward, regex("mogotio|mogoti", ignore_case = TRUE)) ~ "Mogotio",
    str_detect(N7Ward, regex("emining", ignore_case = TRUE)) ~ "Emining",
    str_detect(N7Ward, regex("marigat|margat", ignore_case = TRUE)) ~ "Marigat",
    TRUE ~ N7Ward
  ))


```


```{r, include=FALSE}

# Create individual tables first
age_sex <- df10 %>%
  filter(!is.na(N1Ageinyears1), !is.na(N2Sex1), N2Sex1 != "") %>%
  mutate(AgeGroup = cut(N1Ageinyears1,
                        breaks = c(0, 14, 24, 34, 44, 100),
                        labels = c("0-14", "15-24", "25-34", "35-44", "45+"),
                        right = TRUE)) %>%
  group_by(AgeGroup, N2Sex1) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Age and Sex Distribution",
         Response = paste(AgeGroup, N2Sex1, sep = " / ")) %>%
  select(Question, Response, Frequency = n, Percent = percent)

education <- df1 %>%
  filter(!is.na(N7Haveyouhadformaleducation1), N7Haveyouhadformaleducation1 != "") %>%
  group_by(N7Haveyouhadformaleducation1) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Education Status of Respondents",
         Response = N7Haveyouhadformaleducation1) %>%
  select(Question, Response, Frequency = n, Percent = percent)

marital <- df10 %>%
  filter(!is.na(N10Whatisyourmaritalstatus), N10Whatisyourmaritalstatus != "") %>%
  group_by(N10Whatisyourmaritalstatus) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Marital Status of Respondents",
         Response = N10Whatisyourmaritalstatus) %>%
  select(Question, Response, Frequency = n, Percent = percent)

religion <- df10 %>%
  filter(!is.na(N9Whatisyourreligion)) %>%
  group_by(N9Whatisyourreligion) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Religion of Respondents",
         Response = N9Whatisyourreligion) %>%
  select(Question, Response, Frequency = n, Percent = percent)

pregnancy <- df10 %>%
  filter(N2Sex1 == "Female" & !is.na(N3Areyoucurrentlypregnant1)) %>%
  group_by(N3Areyoucurrentlypregnant1) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Pregnancy Status (Females only)",
         Response = N3Areyoucurrentlypregnant1) %>%
  select(Question, Response, Frequency = n, Percent = percent)

alcohol <- df10 %>%
  filter(!is.na(N15Doyouconsumealcohol)) %>%
  group_by(N15Doyouconsumealcohol) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Alcohol Consumption",
         Response = N15Doyouconsumealcohol) %>%
  select(Question, Response, Frequency = n, Percent = percent)

sex_partners <- df10 %>%
  filter(!is.na(N20Howmanysexualpartnershaveyouhadinthelast12months)) %>%
  group_by(N20Howmanysexualpartnershaveyouhadinthelast12months) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Number of Sexual Partners in Last 12 Months",
         Response = N20Howmanysexualpartnershaveyouhadinthelast12months) %>%
  select(Question, Response, Frequency = n, Percent = percent)

circumcision <- df10 %>%
  filter(!is.na(N49Haveyoubeencircumcised)) %>%
  group_by(N49Haveyoubeencircumcised) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Circumcision Status",
         Response = N49Haveyoubeencircumcised) %>%
  select(Question, Response, Frequency = n, Percent = percent)

tattoos <- df10 %>%
  filter(!is.na(N54Haveyouhadanytraditionalmarkstattoosbodyincisionsorpiercingsd)) %>%
  group_by(N54Haveyouhadanytraditionalmarkstattoosbodyincisionsorpiercingsd) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1),
         Question = "Traditional Marks / Tattoos / Piercings",
         Response = N54Haveyouhadanytraditionalmarkstattoosbodyincisionsorpiercingsd) %>%
  select(Question, Response, Frequency = n, Percent = percent)

# Convert Response columns to character in each table
age_sex <- age_sex %>% mutate(Response = as.character(Response))
education <- education %>% mutate(Response = as.character(Response))
marital <- marital %>% mutate(Response = as.character(Response))
religion <- religion %>% mutate(Response = as.character(Response))
pregnancy <- pregnancy %>% mutate(Response = as.character(Response))
alcohol <- alcohol %>% mutate(Response = as.character(Response))
sex_partners <- sex_partners %>% mutate(Response = as.character(Response))
circumcision <- circumcision %>% mutate(Response = as.character(Response))
tattoos <- tattoos %>% mutate(Response = as.character(Response))

# Now combine
demo_table <- bind_rows(age_sex, education, marital, religion,
                        pregnancy, alcohol, sex_partners, circumcision, tattoos)


```

```{r, include=TRUE}
demo_table %>%
  kable("html",
        caption = "Table 1: Demographic, Reproductive, Behavioral, and Cultural Characteristics of Respondents",
        col.names = c("Question", "Response", "Frequency", "%")) %>%
  kable_styling(full_width = FALSE,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                position = "center") %>%
  collapse_rows(columns = 1, valign = "top")
```






```{r, include=FALSE}
df10 <- df10 %>%
  mutate(AgeGroup = cut(N1Ageinyears1,
                        breaks = c(0, 24, 34, 44, 54, Inf),
                        labels = c("<25", "25-34", "35-44", "45-54", "≥55"),
                        right = TRUE))

```




```{r, include=FALSE}
df10 <- df10 %>%
  mutate(
    HBV_Status = case_when(
      PositiveforHepatitisB == "Yes" ~ "Positive",
      NegativeforHepatitisB == "Yes" ~ "Negative",
      Dontknow == "Yes" ~ "Dontknow",
      TRUE ~ NA_character_
    )
  )

```

```{r, include=FALSE}
df10_clean <- df10 %>%
  filter(!is.na(HBV_Status))

```


```{r, include=FALSE}

sex_tab <- df10_clean %>%
  filter(!is.na(HBV_Status), !is.na(N2Sex1)) %>%   # filter nulls in both variables
  group_by(N2Sex1, HBV_Status) %>%
  summarise(n = n(), .groups = "drop") %>%
  pivot_wider(
    id_cols = N2Sex1,
    names_from = HBV_Status,
    values_from = n,
    values_fill = list(n = 0)
  ) %>%
  mutate(
    Pos_pct = round(100 * Positive / sum(Positive), 1),
    Neg_pct = round(100 * Negative / sum(Negative), 1),
    Positive = paste0(Positive, " (", Pos_pct, "%)"),
    Negative = paste0(Negative, " (", Neg_pct, "%)")
  ) %>%
  select(Sex = N2Sex1, Positive, Negative)

```

```{r, include=TRUE}
# Print in kable format
sex_tab %>%
  kable(caption = "Table: HBV Status by Sex") %>%
  kable_styling(full_width = FALSE, position = "center")
```


```{r, include=FALSE}
# Keep only Positive and Negative, drop Dontknow & NAs
df10_clean <- df10_clean %>%
  filter(HBV_Status %in% c("Positive", "Negative")) %>%
  mutate(HBV_binary = ifelse(HBV_Status == "Positive", 1, 0))

# Double check
table(df10_clean$HBV_binary, df10_clean$HBV_Status)



```



```{r, include=FALSE}
library(dplyr)
library(broom)
library(knitr)
library(kableExtra)

# Recode outcome
df10_clean <- df10_clean %>%
  mutate(HBV_binary = ifelse(HBV_Status == "Positive", 1, 0))

# Logistic regression
model_sex <- glm(HBV_binary ~ N2Sex1, data = df10_clean, family = binomial)

# Get tidy output with ORs and CIs
model_results <- tidy(model_sex, conf.int = TRUE, exp = TRUE) %>%
  mutate(across(estimate:conf.high, round, 2)) %>%
  rename(
    Term = term,
    OR = estimate,
    CI_low = conf.low,
    CI_high = conf.high,
    p_value = p.value
  )

```


```{r, include=TRUE}
# Print in kable format
kable(model_results, format = "markdown", caption = "Logistic Regression: HBV Positive vs Not Positive") %>%
  kable_styling(full_width = FALSE, position = "left")
```



```{r, include=TRUE}
# Keep only Positive and Negative, drop Dontknow & NAs
df101 <- df10 %>%
  filter(HBV_Status %in% c("Positive", "Negative")) %>%
  mutate(HBV_binary = ifelse(HBV_Status == "Positive", 1, 0))

# Double check
table(df101$HBV_binary, df101$HBV_Status)
```


```{r, include=FALSE}
alias(lm(HBV_binary ~ N2Sex1 + AgeGroup + N10Whatisyourmaritalstatus +
           N7Haveyouhadformaleducation1 + N49Haveyoubeencircumcised +
           N20Howmanysexualpartnershaveyouhadinthelast12months +
           N44Doyoushave + N15Doyouconsumealcohol,
         data = df101))

```


```{r, include=FALSE}
model_adj_firth <- logistf(
  HBV_binary ~ N2Sex1 + AgeGroup + N10Whatisyourmaritalstatus + N44Doyoushave,
  data = df101
)
summary(model_adj_firth)

```

```{r, include=TRUE}

# Extract OR and CI
results_firth <- exp(cbind(OR = coef(model_adj_firth),
                           confint(model_adj_firth))) %>%
  as.data.frame() %>%
  rownames_to_column("Variable")

# Print to check names
print(colnames(results_firth))

# Force rename to consistent names
colnames(results_firth) <- c("Variable", "OR", "CI_lower", "CI_upper")

# Create clean table
results_firth <- results_firth %>%
  mutate(`aOR (95% CI)` = sprintf("%.2f (%.2f–%.2f)", OR, CI_lower, CI_upper)) %>%
  select(Variable, `aOR (95% CI)`)


results_firth
```






```{r, include=FALSE}

library(readr)
DF1 <- read_csv("D:/Downloads/Final Household data Edit.csv")
```



```{r, include=FALSE}
att1 <- DF1 %>%
  summarise(
    Yes = sum(Yes13 == "Yes", na.rm = TRUE),
    No  = sum(No14 == "Yes", na.rm = TRUE),
    DontKnow = sum(DontKnow21 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "Do you think you can get Hepatitis B? (n=203)")


att2 <- DF1 %>%
  summarise(
    Fear = sum(Fear == "Yes", na.rm = TRUE),
    Shame = sum(Shame == "Yes", na.rm = TRUE),
    Surprise = sum(Surprise == "Yes", na.rm = TRUE),
    Saddness = sum(Saddness == "Yes", na.rm = TRUE),
    Other = sum(OtherSpecify6 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "What would be your reaction if you found that you have Hepatitis B? (n=203)")

att3 <- DF1 %>%
  summarise(
    HealthWorker = sum(Healthworker == "Yes", na.rm = TRUE),
    Spouse = sum(Spouse == "Yes", na.rm = TRUE),
    Parents = sum(`Parent1` == "Yes", na.rm = TRUE),  # use backticks for special chars
    Children = sum(Child == "Yes", na.rm = TRUE),
    OtherRelatives = sum(Otherrelatives == "Yes", na.rm = TRUE),
    ReligiousLeaders = sum(Religiousleaders == "Yes", na.rm = TRUE),
    NoOne = sum(Noone == "Yes", na.rm = TRUE),
    Other = sum(Otherspecify7 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "Who would you talk to about your illness? (n=203)")


# 4. What will you do if you think you have symptoms ---------------
att4 <- DF1 %>%
  summarise(
    HealthFacility = sum(Gotohealthfacility == "Yes", na.rm = TRUE),
    TraditionalHealer = sum(Gototraditionalhealer == "Yes", na.rm = TRUE),
    SelfMedication = sum(Selfmedicate == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "What will you do if you think that you have symptoms of Hepatitis B? (n=203)")

# 5. At what stage will you go to health facility ------------------
att5 <- DF1 %>%
  summarise(
    After34Weeks = sum(After34weeksoftheappearanceofsymptoms == "Yes", na.rm = TRUE),
    Immediately = sum(AssoonasIrealizethesymptomsareofHepatitisB == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "If you had symptoms of HB, at what stage will you go to the health facility? (n=203)")

# 6. How expensive is diagnosis/treatment --------------------------
att6 <- DF1 %>%
  summarise(
    Free = sum(Free == "Yes", na.rm = TRUE),
    Reasonable = sum(Reasonable == "Yes", na.rm = TRUE),
    SomewhatExp = sum(Somewhatexpensive == "Yes", na.rm = TRUE),
    Expensive = sum(Expensive == "Yes", na.rm = TRUE),
    DontKnow = sum(Dontknow == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "How expensive do you think is the diagnosis and treatment of Hepatitis B? (n=203)")

# 7. Which source do you trust the most ----------------------------
att7 <- DF1 %>%
  summarise(
    Relatives = sum(Relativeorneighbors == "Yes", na.rm = TRUE),
    ReligiousLeaders = sum(Imamspastorsorreligiousleaders == "Yes", na.rm = TRUE),
    TraditionalLeaders = sum(Communitystraditionalleaderseldersandmobilizers == "Yes", na.rm = TRUE),
    Chiefs = sum(Chiefandadministrationleaders == "Yes", na.rm = TRUE),
    HealthWorkers = sum(Healthworkers == "Yes", na.rm = TRUE),
    CHV = sum(Communityhealthvolunteers == "Yes", na.rm = TRUE),
    Poster = sum(Poster == "Yes", na.rm = TRUE),
    Television = sum(Television1 == "Yes", na.rm = TRUE),
    Radio = sum(Radio1 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "Of the sources of information you mentioned, which one(s) do you trust the most? (n=203)")

# 8. How concerned if family member gets HB ------------------------
att8 <- DF1 %>%
  summarise(
    VeryConcerned = sum(VeryConcern == "Yes", na.rm = TRUE),
    SomewhatConcerned = sum(Somewhatconcern == "Yes", na.rm = TRUE),
    NotConcerned = sum(Notveryconcern == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "n") %>%
  mutate(Percent = round(100 * n / sum(n), 1),
         Question = "How concerned are you if a family member may get sick with HB? (n=203)")

```



```{r, include=TRUE}
## Standardize column names across all attitude tables
att_list <- list(att1, att2, att3, att4, att5, att6, att7, att8) %>%
  lapply(function(df) {
    df <- df %>%
      rename(Frequency = ifelse("n" %in% names(df), "n", names(df)[3]),
             Percent   = ifelse(!("Percent" %in% names(df)), names(df)[4], "Percent"))
    return(df)
  })

# Combine all attitude subsections
attitude_table <- bind_rows(att_list) %>%
  select(Question, Response, Frequency, Percent)

# Nicely print
attitude_table %>%
  kable("html", 
        caption = "Table 2: Attitudes towards Hepatitis B among respondents (Baringo County, Kenya, 2019)",
        col.names = c("Attitude items", "Response", "Frequency", "%")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                position = "center") %>%
  collapse_rows(columns = 1, valign = "top")

```




```{r, include=FALSE}

# 1. Ever screened
pr1 <- DF1 %>%
  summarise(
    Yes = sum(Yes13 == "Yes", na.rm = TRUE),
    No  = sum(No14 == "Yes", na.rm = TRUE),
    DontKnow = sum(DontKnow21 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "Frequency") %>%
  mutate(Percent = round(100 * Frequency / sum(Frequency), 1),
         Question = "Have you ever been screened for Hepatitis B? (n=206)")

# 2. Vaccination
pr2 <- DF1 %>%
  summarise(
    Yes = sum(Yes14 == "Yes", na.rm = TRUE),
    No  = sum(No15 == "Yes", na.rm = TRUE),
    DontKnow = sum(Dontknow22 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "Frequency") %>%
  mutate(Percent = round(100 * Frequency / sum(Frequency), 1),
         Question = "Have you been vaccinated against Hepatitis B? (n=272)")

# 3. Go to barbershop
pr3 <- DF1 %>%
  count(N81Doyougotoabarbershopregularly, name = "Frequency") %>%
  filter(!is.na(N81Doyougotoabarbershopregularly)) %>%
  mutate(Response = N81Doyougotoabarbershopregularly,
         Percent = round(100 * Frequency / sum(Frequency), 1),
         Question = "Do you go to a barber shop regularly? (n=272)") %>%
  select(Question, Response, Frequency, Percent)

# 4. Barber uses safe equipment
pr4 <- DF1 %>%
  summarise(
    Yes = sum(Yes14 == "Yes", na.rm = TRUE),
    No  = sum(No15 == "Yes", na.rm = TRUE),
    DontKnow = sum(Dontknow22 == "Yes", na.rm = TRUE)
  ) %>%
  pivot_longer(cols = everything(), names_to = "Response", values_to = "Frequency") %>%
  mutate(Percent = round(100 * Frequency / sum(Frequency), 1),
         Question = "Does your barber change/sanitize blade or use safe equipment for ear/nose piercing? (n=100)")

```


```{r, include=TRUE}
# Combine all
practice_table <- bind_rows(pr1, pr2, pr3, pr4) %>%
  select(Question, Response, Frequency, Percent)

# Nicely print
practice_table %>%
  kable("html", 
        caption = "Table 3: Practice related to Hepatitis B among the community, Baringo County, Kenya, 2019",
        col.names = c("Practice items", "Response", "Frequency", "%")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                position = "center") %>%
  collapse_rows(columns = 1, valign = "top")

```






```{r, include=FALSE}
# Helper function to generate summary tables
make_table <- function(df, cols, question, n){
  df %>%
    summarise(across(all_of(cols), ~ sum(. == "Yes", na.rm = TRUE))) %>%
    pivot_longer(cols = everything(),
                 names_to = "Response",
                 values_to = "Frequency") %>%
    mutate(
      Percent = round(100 * Frequency / sum(Frequency), 1),
      Question = paste0(question, " (n=", n, ")")
    )
}

# 1. Ever heard of Hepatitis B -----------------
t1 <- make_table(DF1, c("Yes13", "No14", "DontKnow21"),
                 "Ever heard of Hepatitis B", 272)

# 2. Causes of Hepatitis B ---------------------
t2 <- make_table(DF1, c("Bacteria", "Virus", "Protozoa", "DontKnow12"),
                 "Causes of Hepatitis B", 203)

# 3. Signs & Symptoms --------------------------
t3 <- make_table(DF1, c("Fever1", "Fatique1", "Lossofappetite1", "Nausea1",
                        "Abdominalpain1", "Jointpain", "Darkurine1",
                        "Greycolouredstools", "Jaundice1"),
                 "Signs and Symptoms of HB disease", 248)

# 4. Know how HB is transmitted ----------------
t4 <- make_table(DF1, c("Yes", "No1", "Dontknow1"),
                 "Know how HB is transmitted", 201)

# 5. How is HB transmitted ---------------------
t5 <- make_table(DF1, c("Havingunprotectedsex", "Contactwithaninfectedperson",
                        "Bloodtransfusion", "Eatingcontaminatedfood","Duringchildbirth",
                        "Usingunsterilizedsyringesneedlesandsurgicalinstruments", "Sharingofneedlesearpiercingtoothextractionandtattooinstruments", "Dontknow15"),
                 "How is HB transmitted", 79)

# 6. Is HB preventable -------------------------
t6 <- make_table(DF1, c("Yes1", "No3", "Dontknow3"),
                 "Is Hepatitis B a preventable disease?", 200)

# 7. How is HB prevented -----------------------
t7 <- make_table(DF1, c("Vaccination", "Havingprotectedsex", "Notsharingcuttingequipment",
                        "Handwashing", "Usingsterilizedequipment", "Preparingfoodinhygienicconditions","Screeningbloodbeforetransfusion"),
                 "How is Hepatitis B prevented?", 87)

# 8. Do you know HB vaccination in routine immunization? ----
t8 <- make_table(DF1, c("Yes2", "No4", "DontKnow5"),
                 "Do you know that Hepatitis B vaccination is given as part of national routine immunization?", 200)
```



```{r, include=TRUE}
# Combine all knowledge subsections (t1 to t8)
knowledge_table_long <- bind_rows(t1, t2, t3, t4, t5, t6, t7, t8) %>%
  select(Question, Response, Frequency, Percent)

# Print nicely
knowledge_table_long %>%
  kable("html", 
        caption = "Table 4: Responses to Hepatitis B knowledge among the community, Baringo County, Kenya, 2019",
        col.names = c("Knowledge items", "Response", "Frequency", "%")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                position = "center") %>%
  collapse_rows(columns = 1, valign = "top")

```





###data2




```{r, include=FALSE}

# ---- Step 1: Clean and categorize Department ----
df2_cat <- df2 %>%
  mutate(DepartmentClean = case_when(
    str_detect(str_to_upper(Q11departmentstationed), "WARD|WARDS") ~ "Ward",
    str_detect(str_to_upper(Q11departmentstationed), "NURSE") ~ "Nursing",
    str_detect(str_to_upper(Q11departmentstationed), "PHARM|PHARMACY|pHARM") ~ "Pharmacy",
    str_detect(str_to_upper(Q11departmentstationed), "LAB|LABORATORY") ~ "Laboratory",
    str_detect(str_to_upper(Q11departmentstationed), "PUBLIC HEALTH|HTS|VCT|CCC|MCH/MATERNITY|MCH") ~ "Public Health/MCH",
    str_detect(str_to_upper(Q11departmentstationed), "PROCUREMENT|ACCOUNTS|RECORD|RECORDS|ReCORDS") ~ "Administration/Records",
    str_detect(str_to_upper(Q11departmentstationed), "SECURITY") ~ "Security",
    str_detect(str_to_upper(Q11departmentstationed), "CLEAN|LAUNDRY") ~ "Cleaning/Maintenance",
    str_detect(str_to_upper(Q11departmentstationed), "KITCHEN") ~ "Kitchen",
    str_detect(str_to_upper(Q11departmentstationed), "SURGERY|SURGICAL|OBSTETRICS/GYNAECOLOGY") ~ "Surgery/Obstetrics",
    str_detect(str_to_upper(Q11departmentstationed), "NUTRITION|MSW|WATVHMAN") ~ "Other",
    TRUE ~ "Other"
  ))

# ---- Step 2: Categorize age, years of practice, and select sociodemographics ----
df2_cat <- df2_cat %>%
  mutate(
    AgeGroup = case_when(
      Q08Ageinyears < 25 ~ "<25",
      Q08Ageinyears >= 25 & Q08Ageinyears <= 34 ~ "25-34",
      Q08Ageinyears >= 35 & Q08Ageinyears <= 44 ~ "35-44",
      Q08Ageinyears >= 45 & Q08Ageinyears <= 54 ~ "45-54",
      Q08Ageinyears >= 55 ~ "≥55",
      TRUE ~ NA_character_
    ),
    YearsPracticeGroup = case_when(
      Q10yearsofpractice < 5 ~ "<5",
      Q10yearsofpractice >= 5 & Q10yearsofpractice <= 10 ~ "5-10",
      Q10yearsofpractice > 10 ~ ">10",
      TRUE ~ NA_character_
    ),
    Sex = factor(Q07Sex, levels = c("Female", "Male")),
    Cadre = factor(Q08Cadre),
    Education = factor(Q09levelofeducation),
    Department = factor(DepartmentClean, levels = c(
      "Ward", "Nursing", "Pharmacy", "Laboratory", 
      "Public Health/MCH", "Administration/Records", 
      "Security", "Cleaning/Maintenance", "Kitchen", 
      "Surgery/Obstetrics", "Other"
    )),
    FacilityLevel = factor(Q05Leveloffacility),
    FacilityOwnership = factor(Q06Facilityownership),
    SubCounty = factor(Q01SubCounty)
  )

# ---- Step 3: Function to generate frequency tables (filter out NAs) ----
freq_table <- function(var, varname) {
  df2_cat %>%
    filter(!is.na({{var}})) %>%   # Filter nulls
    count({{var}}, name = "n") %>%
    mutate(percent = round(100 * n / sum(n), 1),
           Variable = varname) %>%
    rename(Value = {{var}})
}

# ---- Step 4: Generate tables for each characteristic ----
tables <- list(
  freq_table(Sex, "Sex"),
  freq_table(AgeGroup, "Age group"),
  freq_table(Education, "Level of education"),
  freq_table(Cadre, "Cadre"),
  freq_table(Department, "Department"),
  freq_table(FacilityLevel, "Facility level"),
  freq_table(FacilityOwnership, "Facility ownership"),
  freq_table(SubCounty, "SubCounty"),
  freq_table(YearsPracticeGroup, "Years of practice")
)

# ---- Step 5: Combine all tables ----
final_table <- bind_rows(tables) %>%
  select(Variable, Value, n, percent)


```


```{r, include=TRUE}
final_table %>%
  kable(
    caption = "Sociodemographic characteristics of participants ",
    col.names = c("Characteristic", "Category", "n", "Percent"),
    align = "lccc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")
```

```{r, include=FALSE}

# ---- Prepare vaccination table ----
vaccine_table <- df2 %>%
  filter(!is.na(Q15Vaccinationstatus)) %>%          # Remove missing values
  count(Q15Vaccinationstatus) %>%                  # Count each category
  mutate(percent = round(100 * n / sum(n), 1)) %>% # Calculate percentage
  rename(Status = Q15Vaccinationstatus)


```

```{r,Vaccination Status, include=TRUE}
vaccine_table %>%
  kable(
    caption = "HBV Vaccination Status of Participants",
    col.names = c("Vaccination status", "n", "Percent"),
    align = "lcc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")
```




##data3


```{r, include=FALSE}

# ---- Categorize variables ----
df3_cat <- df3 %>%
  mutate(
    AgeGroup = case_when(
      Age < 25 ~ "<25",
      Age >= 25 & Age <= 34 ~ "25-34",
      Age >= 35 & Age <= 44 ~ "35-44",
      Age >= 45 & Age <= 54 ~ "45-54",
      Age >= 55 ~ "≥55",
      TRUE ~ NA_character_
    ),
    EducationGroup = case_when(
      str_detect(LevelofEducation, "None|No") ~ "None/No Education",
      str_detect(LevelofEducation, "Primary") ~ "Primary",
      str_detect(LevelofEducation, "Secondary") ~ "Secondary",
      str_detect(LevelofEducation, "Tertiary|College|University") ~ "Tertiary",
      TRUE ~ "Other"
    ),
    MaritalStatus = MaritalStatus,
    PrisonType = PrisonType,
    RespondentCategory = Categoryoftherespondent1,
    ReligionGroup = case_when(
      !is.na(Protestant) & Protestant == "Yes" ~ "Protestant",
      !is.na(Catholic) & Catholic == "Yes" ~ "Catholic",
      !is.na(Muslim) & Muslim == "Yes" ~ "Muslim",
      TRUE ~ "Other"
    )
  ) %>%
  filter(!is.na(AgeGroup), !is.na(EducationGroup), !is.na(MaritalStatus))

# ---- Helper function for frequency table ----
freq_table <- function(var, varname) {
  df3_cat %>%
    count({{var}}) %>%
    mutate(percent = round(100 * n / sum(n), 1),
           Variable = varname) %>%
    rename(Category = {{var}})
}

# ---- Generate tables ----
tables <- list(
  freq_table(AgeGroup, "Age group"),
  freq_table(EducationGroup, "Level of education"),
  freq_table(MaritalStatus, "Marital status"),
  freq_table(PrisonType, "Prison type"),
  freq_table(RespondentCategory, "Respondent category"),
  freq_table(ReligionGroup, "Religion")
)

# ---- Combine all tables ----
final_demo_table <- bind_rows(tables) %>%
  select(Variable, Category, n, percent)


```

```{r, include=TRUE}
final_demo_table %>%
  kable(
    caption = "Sociodemographic characteristics of respondents",
    col.names = c("Characteristic", "Category", "n", "Percent"),
    align = "lccc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")
```



```{r, include=TRUE}

df3 %>%
  count(`Field screening diaspot (HBsAg) RDT`) %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  kable(
    caption = "HBV Positivity (Field Screening Diaspot HBsAg RDT)",
    col.names = c("HBV Status", "n", "Percent"),
    align = "lcc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")


```



```{r, include=TRUE}

df3_cat %>%
  group_by(AgeGroup, N24HaveyoueverbeenvaccinatedagainstHepatitisBbefore) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  arrange(AgeGroup) %>%
  kable(
    caption = "HBV Vaccination Status by Age Group",
    col.names = c("Age Group", "Vaccinated", "n", "Percent"),
    align = "lccc"
  ) %>%
  kable_styling(full_width = FALSE, position = "center")


```


```{r, include=FALSE}

kenya_shape <- ne_states(country = "Kenya", returnclass = "sf")


#devtools::install_github("ropensci/rnaturalearthhires")
kenya_shape <- subcounty_shape %>%
  group_by(county) %>%
  summarise()


baringo_shape <- subcounty_shape %>%
  filter(county == "Baringo") %>%
  mutate(subcounty = gsub(" Sub County", "", subcounty))

baringo_county <- kenya_shape %>%
  filter(county == "Baringo")

```




```{r, include=FALSE}
library(rnaturalearth)
library(rnaturalearthdata)
library(ggplot2)
library(dplyr)
library(ggspatial)
library(patchwork)
library(ggtext)

# Map 1: Baringo in Kenya
map_kenya <- ggplot() +
  geom_sf(data = kenya_shape, fill = "gray90", color = "white") +
  geom_sf(data = baringo_county, fill = "#006d2c", color = "black") +
  labs(title = "Location of Baringo County") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

# Map 2: Subcounties of Baringo
map_baringo <- ggplot(data = baringo_shape) +
  geom_sf(aes(fill = subcounty), color = "white", linewidth = 0.5) +
  scale_fill_brewer(palette = "Set3", name = "Subcounties") +
  geom_sf_text(aes(label = subcounty), size = 3, color = "black", fontface = "bold") +
  labs(
    title = "Subcounties",
    subtitle = "Administrative boundaries showing the seven subcounties",
    caption = "Source: Kenya Open Data / GADM | Map: ARANI"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5, color = "gray40"),
    legend.position = "right",
    panel.background = element_rect(fill = "aliceblue", color = NA)
  ) +
  annotation_north_arrow(location = "tr", which_north = "true",
                         style = north_arrow_fancy_orienteering) +
  annotation_scale(location = "bl", width_hint = 0.3)

# Combine both maps
final_map <- map_kenya + map_baringo +
  plot_annotation(
    title = "Baringo County in National and Local Context",
    theme = theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
  )


```


```{r, include=TRUE}
# Display
final_map

```


```{r, include=FALSE}
# Step 0: Convert Yes/No to 1/0
df1 <- DF1 %>%
  mutate(
    PositiveforHepatitisB = ifelse(PositiveforHepatitisB == "Yes", 1, 0),
    NegativeforHepatitisB = ifelse(NegativeforHepatitisB == "Yes", 1, 0),
    Dontknow_HBV = ifelse(Dontknow == "Yes", 1, 0),
    Vaccination = ifelse(Vaccination == "Yes", 1, 0),
    EmployedintheHealthSector = ifelse(EmployedintheHealthSector == "Yes", 1, 0)
  )

# Step 1: Summarize by sub-county
summary_table <- df1 %>%
  group_by(N6SubCounty) %>%
  summarise(
    No_tested = n(),
    No_positive = sum(PositiveforHepatitisB, na.rm = TRUE),
    No_negative = sum(NegativeforHepatitisB, na.rm = TRUE),
    No_dontknow = sum(Dontknow_HBV, na.rm = TRUE),
    HCW_Vaccinated = sum(Vaccination == 1 & EmployedintheHealthSector == 1, na.rm = TRUE),
    Total_vaccinated = sum(Vaccination, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(Positivity_rate = round(100 * No_positive / No_tested, 1))

# Step 2: Add total row
total_row <- summary_table %>%
  summarise(
    N6SubCounty = "Total",
    No_tested = sum(No_tested),
    No_positive = sum(No_positive),
    No_negative = sum(No_negative),
    No_dontknow = sum(No_dontknow),
    HCW_Vaccinated = sum(HCW_Vaccinated),
    Total_vaccinated = sum(Total_vaccinated),
    Positivity_rate = round(100 * sum(No_positive) / sum(No_tested), 1)
  )

summary_table <- bind_rows(summary_table, total_row)




```

```{r, include=TRUE}
# Step 3: Pretty print as a formatted table
summary_table %>%
  rename(
    "Sub-County" = N6SubCounty,
    "No. Tested" = No_tested,
    "No. Positive" = No_positive,
    "No. Negative" = No_negative,
    "No. Don't know" = No_dontknow,
    "HCW Vaccinated" = HCW_Vaccinated,
    "Total Vaccinated" = Total_vaccinated,
    "Positivity Rate (%)" = Positivity_rate
  ) %>%
  kable(format = "pipe", align = "c") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover"))

```




```{r, include=FALSE}

# --- Libraries ---
library(sf)
library(dplyr)
library(ggplot2)
library(viridis)
library(ggspatial)
library(patchwork)

# --- 1️⃣ Load shapefile ---
subcounty_shape <- st_read("D:/Documents/R Studio/R_Statistical-Language/shapefiles/ke_subcounty(2)/ke_subcounty.shp")

# --- 2️⃣ Filter for Baringo County only ---
baringo_shape <- subcounty_shape %>%
  filter(county == "Baringo") %>%
  mutate(subcounty_clean = gsub(" Sub County", "", subcounty),
         subcounty_clean = trimws(subcounty_clean))

# --- 3️⃣ Prepare summary table ---
summary_table_clean <- summary_table %>%
  rename(
    subcounty = N6SubCounty,
    No_Tested = No_tested,
    No_Positive = No_positive,
    No_Negative = No_negative,
    No_DontKnow = No_dontknow,
    HCW_Vaccinated = HCW_Vaccinated,
    Total_Vaccinated = Total_vaccinated,
    Positivity_Rate = Positivity_rate
  ) %>%
  filter(subcounty != "Total")

# --- 4️⃣ Join summary data with spatial layer ---
baringo_data <- baringo_shape %>%
  left_join(summary_table_clean, by = c("subcounty_clean" = "subcounty"))

library(sf)
library(dplyr)
library(ggplot2)
library(viridis)
library(ggspatial)
library(patchwork)

# --- Function for pretty single maps ---
make_map1 <- function(data, fill_var, title) {
  ggplot(data) +
    geom_sf(aes(fill = .data[[fill_var]]), color = "white", linewidth = 0.5) +
    scale_fill_viridis_c(option = "plasma", direction = -1, name = title, na.value = "gray90") +
    geom_sf_text(aes(label = subcounty_clean), size = 3.2, color = "black", fontface = "bold") +
    labs(title = title, subtitle = "Baringo County, Kenya") +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 10, hjust = 0.5, color = "gray40"),
      legend.position = "bottom",
      legend.key.width = unit(2, "cm"),
      panel.background = element_rect(fill = "aliceblue", color = NA)
    )
}
```




```{r, include=FALSE}
make_map2 <- function(data, fill_var, title) {
  ggplot(data) +
    geom_sf(aes(fill = .data[[fill_var]]), color = "white", linewidth = 0.5) +
    coord_sf(datum = NA) +  # ensures consistent scaling
    scale_fill_viridis_c(option = "plasma", direction = -1, name = title, na.value = "gray90") +
    geom_sf_text(aes(label = subcounty_clean), size = 3.2, color = "black", fontface = "bold") +
    labs(title = title, subtitle = "Baringo County, Kenya") +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 10, hjust = 0.5, color = "gray40"),
      legend.position = "bottom",
      legend.key.width = unit(2, "cm"),
      panel.background = element_rect(fill = "aliceblue", color = NA)
    )
}


```


```{r, include=FALSE}

# --- Make all thematic maps ---
map_tested     <- make_map2(baringo_data, "No_Tested", "No. Tested")
map_positive   <- make_map2(baringo_data, "No_Positive", "No. Positive")
map_negative   <- make_map2(baringo_data, "No_Negative", "No. Negative")
map_vaccinated <- make_map2(baringo_data, "Total_Vaccinated", "Total Vaccinated")
map_hcw_vax    <- make_map2(baringo_data, "HCW_Vaccinated", "HCWs Vaccinated")
map_rate       <- make_map2(baringo_data, "Positivity_Rate", "Positivity Rate (%)")

# --- Combine in a clean 3x2 grid layout ---
combined_plot <- (map_tested + map_positive + map_negative) /
  (map_vaccinated + map_hcw_vax + map_rate) +
  plot_annotation(
    title = "Hepatitis B Indicators by Subcounty — Baringo County",
    caption = "Source: Field Data & Kenya Open Data | Map: Your Name",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.caption = element_text(size = 9, color = "gray40")
    )
  )

```


```{r, include=TRUE}
# --- Display the combined plot instead of saving ---
print(combined_plot)

```





